# -*- coding: utf-8 -*-
"""BigQueryGeospatialMapper

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1VkUIHkvmIFFbGefO0j4oTr9TmEfQ4zrU

# PAIS data fromat for BigQuery
- Converting PAIS data to be supported in BigQuery
"""

# @title Setup
from google.colab import auth
from google.cloud import bigquery
from google.colab import data_table

project = '|project_id|' # Project ID inserted based on the query results selected to explore
location = '|location|' # Location inserted based on the query results selected to explore
client = bigquery.Client(project=project, location=location)
data_table.enable_dataframe_formatter()
auth.authenticate_user()

# Commented out IPython magic to ensure Python compatibility.
# @title Install useful library
# %pip install geopandas

# @title Import Libraries
import pandas as pd
from shapely import wkt
import csv
import geopandas as gpd
from google.colab import files

# @title Read csv file into geopandas dataframe
gdf = gpd.read_file('pais_subset_formatted.csv')
gdf['geometry'] = gdf['field_3'].apply(wkt.loads)

# @title Convert from Pseudo-Mercator to WGS84
gdf.crs = "epsg:3857"
projected = gdf.to_crs(epsg=4326)

# @title Drop repeated field and write the final file to a csv
projected.drop('field_3', axis=1, inplace=True)
pd.DataFrame(projected.assign(geometry=projected["geometry"].apply(lambda p: p.wkt))).to_csv('pais_subset_scaled.csv', index=False)

# @title Download csv file
files.download('pais_subset_scaled.csv')